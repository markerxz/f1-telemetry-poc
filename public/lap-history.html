<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Lap History - Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: #a4d233;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(164, 210, 51, 0.6);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .controls {
            background: #1a1a1a;
            border: 2px solid #a4d233;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .button {
            background: #a4d233;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }

        .button:hover {
            background: #b5e344;
        }

        .lap-table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
        }

        .lap-table th {
            background: #0f0f0f;
            color: #a4d233;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #a4d233;
            position: sticky;
            top: 0;
        }

        .lap-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #222;
        }

        .lap-table tr:hover {
            background: #2a2a2a;
        }

        .best-lap {
            background: #1a3a1a !important;
        }

        .invalid-lap {
            color: #ff4444 !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
            color: #888;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            color: #a4d233;
            font-weight: bold;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ F1 Lap History</h1>
        <div class="subtitle">Database Records</div>

        <div class="controls">
            <div>
                <button class="button" onclick="loadRecentLaps()">üîÑ Refresh</button>
                <button class="button" onclick="window.location.href='/'">üè† Dashboard</button>
                <button class="button" onclick="window.location.href='/lap-data-preview.html'">üìä Preview</button>
            </div>
            <div style="color: #888;">
                <span id="recordCount">0</span> laps in database
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalLaps">0</div>
                <div class="stat-label">Total Laps</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="validLaps">0</div>
                <div class="stat-label">Valid Laps</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bestLapTime">--:--.---</div>
                <div class="stat-label">Best Lap</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueDrivers">0</div>
                <div class="stat-label">Drivers</div>
            </div>
        </div>

        <div id="loading" class="loading">Loading laps from database...</div>

        <table class="lap-table" id="lapTable" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Driver</th>
                    <th>Track</th>
                    <th>Session</th>
                    <th>Lap #</th>
                    <th>Valid</th>
                    <th>Lap Time</th>
                    <th>Sector 1</th>
                    <th>Sector 2</th>
                    <th>Sector 3</th>
                    <th>Date/Time</th>
                </tr>
            </thead>
            <tbody id="lapTableBody">
            </tbody>
        </table>
    </div>

    <script>
        function formatMs(ms) {
            if (!ms || ms === 0) return '--:--.---';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = ms % 1000;
            return `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }

        async function loadRecentLaps() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('lapTable').style.display = 'none';

                const response = await fetch('/api/laps/recent');
                const laps = await response.json();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('lapTable').style.display = 'table';

                if (laps.length === 0) {
                    document.getElementById('lapTableBody').innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">No laps in database yet. Drive some laps!</td></tr>';
                    return;
                }

                // Calculate stats
                const validLaps = laps.filter(l => l.IS_VALID === 1);
                const bestLap = validLaps.length > 0 ? Math.min(...validLaps.map(l => l.LAP_TIME_MS)) : null;
                const uniqueDrivers = [...new Set(laps.map(l => l.DRIVER_NAME))].length;

                document.getElementById('totalLaps').textContent = laps.length;
                document.getElementById('validLaps').textContent = validLaps.length;
                document.getElementById('bestLapTime').textContent = bestLap ? formatMs(bestLap) : '--:--.---';
                document.getElementById('uniqueDrivers').textContent = uniqueDrivers;
                document.getElementById('recordCount').textContent = laps.length;

                // Render table
                const tbody = document.getElementById('lapTableBody');
                tbody.innerHTML = laps.map(lap => {
                    const isBest = lap.IS_VALID === 1 && lap.LAP_TIME_MS === bestLap;
                    const isInvalid = lap.IS_VALID === 0;
                    const rowClass = isBest ? 'best-lap' : '';
                    const validIcon = lap.IS_VALID === 1 ? '‚úÖ' : '‚ùå';
                    const bestBadge = isBest ? ' üèÜ' : '';
                    const invalidClass = isInvalid ? 'invalid-lap' : '';

                    return `<tr class="${rowClass}">
                        <td>${lap.LAP_ID}</td>
                        <td>${lap.DRIVER_NAME || 'Unknown'}</td>
                        <td>${lap.TRACK_NAME || '--'}</td>
                        <td>${lap.SESSION_TYPE || '--'}</td>
                        <td class="${invalidClass}">${lap.LAP_NUMBER}${bestBadge}</td>
                        <td>${validIcon}</td>
                        <td class="${invalidClass}">${lap.LAP_TIME_FORMATTED || formatMs(lap.LAP_TIME_MS)}</td>
                        <td>${formatMs(lap.SECTOR1_MS)}</td>
                        <td>${formatMs(lap.SECTOR2_MS)}</td>
                        <td>${formatMs(lap.SECTOR3_MS)}</td>
                        <td>${formatDateTime(lap.CREATED_AT)}</td>
                    </tr>`;
                }).join('');

            } catch (err) {
                console.error('Error loading laps:', err);
                document.getElementById('loading').innerHTML = '<span style="color: #ff4444;">Error loading laps from database. Check console for details.</span>';
            }
        }

        // Load laps on page load
        loadRecentLaps();

        // Auto-refresh every 5 seconds
        setInterval(loadRecentLaps, 5000);
    </script>
</body>
</html>

