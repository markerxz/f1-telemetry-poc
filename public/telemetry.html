<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Dashboard - Live</title>
    <link href="https://fonts.cdnfonts.com/css/akrobat" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Mikhus/canvas-gauges@2.1.7/gauge.min.js"></script>
    <style>
        :root {
            --bg-dark: #050508;
            --card-bg: rgba(20, 25, 40, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent-cyan: #a4d233;
            --accent-red: #ff3b3b;
            --accent-green: #00ff66;
            --accent-yellow: #ffcc00;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --font-head: 'Akrobat', sans-serif;
            --font-body: 'Akrobat', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #0a0f1a 0%, #000 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            background: rgba(0, 0, 0, 0.6);
            border-bottom: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .logo img {
            height: 35px;
            width: auto;
        }

        .header-center {
            font-family: var(--font-head);
            font-size: 14px;
            color: #a4d233;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px var(--accent-green);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }

        /* === MAIN GRID === */
        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr 1fr 280px 320px;
            grid-template-rows: 380px 1fr;
            gap: 12px;
            padding: 15px;
            height: calc(100vh - 55px);
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 18px;
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-title {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        /* === COL 1: DRIVER INFO === */
        .driver-card .driver-name {
            font-family: var(--font-head);
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 5px;
        }

        .driver-card .driver-name span {
            color: var(--accent-cyan);
        }

        .driver-card .team-name {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .driver-card .lap-time-section {
            margin-bottom: 20px;
        }

        .driver-card .lap-time-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .driver-card .lap-time-value {
            font-family: var(--font-head);
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .driver-card .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        .driver-card .stat-label {
            color: var(--text-muted);
        }

        .driver-card .stat-value {
            font-family: var(--font-head);
            font-weight: 700;
        }

        .driver-card .session-info-section {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .driver-card .session-info-section .card-title {
            margin-bottom: 8px;
        }

        /* === COL 2 & 3: GAUGES === */
        .gauge-card {
            position: relative;
            align-items: center;
            justify-content: center;
        }

        .gauge-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
        }

        .gauge-wrapper::before {
            content: '';
            position: absolute;
            width: 90%;
            height: 90%;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.03);
            pointer-events: none;
        }

        .gauge-center {
            position: absolute;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%);
            z-index: 10;
            pointer-events: none;
        }

        .gauge-value {
            font-family: var(--font-head);
            font-size: 56px;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 0 20px currentColor;
        }

        .gauge-unit {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 8px;
            letter-spacing: 3px;
            font-weight: 700;
        }

        .gauge-stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: auto;
            padding-top: 10px;
        }

        .gauge-stat-pill {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }

        /* === COL 4: TEMPERATURES === */
        .temp-card {
            grid-column: 4;
            grid-row: 1;
        }

        .temp-card .temp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            flex: 1;
        }

        .temp-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .temp-gauge-mini {
            width: 55px;
            height: 55px;
            position: relative;
        }

        .temp-val {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-head);
            font-size: 12px;
            font-weight: 700;
        }

        .temp-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* === COL 5: TRACE CHARTS === */
        .traces-card {
            padding: 10px;
            grid-column: 5;
            grid-row: 1 / 3;
        }

        .traces-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 100%;
        }

        .trace-box {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 8px 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .trace-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .trace-chart-wrapper {
            flex: 1;
            min-height: 0;
        }

        /* === ROW 2: ANALYSIS === */
        .analysis-card {
            grid-column: 1 / 5;
        }

        .analysis-chart-wrapper {
            flex: 1;
            min-height: 0;
        }

        .analysis-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .legend-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        /* Utility Colors */
        .text-cyan {
            color: var(--accent-cyan);
        }

        .text-red {
            color: var(--accent-red);
        }

        .text-green {
            color: var(--accent-green);
        }

        .text-yellow {
            color: var(--accent-yellow);
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <header class="header">
        <div class="logo"><img src="AI_Racing_Simulator_Logo.png" alt="AI Racing Simulator"></div>
        <div class="header-center">Telemetry Dashboard</div>
        <div class="live-badge">
            LIVE DATA <div class="live-dot"></div>
        </div>
    </header>

    <!-- MAIN DASHBOARD GRID -->
    <main class="dashboard">

        <!-- COL 1: Driver Info -->
        <div class="card driver-card">
            <div class="card-title">Driver</div>
            <div class="driver-name" id="driverDisplay">Loading<span>...</span></div>
            <div class="team-name" id="teamDisplay">-</div>

            <div class="lap-time-section">
                <div class="lap-time-label">LAP TIME</div>
                <div class="lap-time-value" id="currentLap">0:00.000</div>
            </div>

            <div class="stat-row">
                <span class="stat-label">MAX SPEED</span>
                <span class="stat-value"><span id="maxSpeed">0</span> km/h</span>
            </div>



            <div class="session-info-section">
                <div class="card-title">Session Info</div>
                <div class="stat-row">
                    <span class="stat-label">SESSION</span>
                    <span class="stat-value text-yellow" id="sessionDisplay">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">LAP</span>
                    <span class="stat-value" id="lapNumber">-</span>
                </div>
            </div>
        </div>

        <!-- COL 2: Speed Gauge -->
        <div class="card gauge-card">
            <div class="gauge-wrapper">
                <canvas id="speedGaugeChart"></canvas>
                <div class="gauge-center">
                    <div class="gauge-value text-cyan" id="speedValue">0</div>
                    <div class="gauge-unit">KM/H</div>
                </div>
            </div>
            <div class="gauge-stats">
                <div class="gauge-stat-pill">AVG: <span id="avgSpeed">0</span></div>
                <div class="gauge-stat-pill">MAX: <span id="maxSpeedGauge">0</span></div>
            </div>
        </div>

        <!-- COL 3: RPM Gauge -->
        <div class="card gauge-card">
            <div class="gauge-wrapper">
                <canvas id="rpmGaugeChart"></canvas>
                <div class="gauge-center">
                    <div class="gauge-value text-red" id="gearValue">N</div>
                    <div class="gauge-unit" id="rpmValue">0 RPM</div>
                </div>
            </div>
            <div class="gauge-stats">
                <div class="gauge-stat-pill">AVG RPM: <span id="avgRpm">0</span></div>
                <div class="gauge-stat-pill">MAX RPM: <span id="maxRpm">15000</span></div>
            </div>
        </div>

        <!-- COL 4: Temperatures -->
        <div class="card temp-card">
            <div class="card-title" style="text-align: center;">Temperature</div>
            <div class="temp-grid">
                <div class="temp-item">
                    <div class="temp-gauge-mini"><canvas id="tempEngine"></canvas>
                        <div class="temp-val text-red" id="engineTempVal">0°C</div>
                    </div>
                    <div class="temp-label">Engine</div>
                </div>
                <div class="temp-item">
                    <div class="temp-gauge-mini"><canvas id="tempBrake"></canvas>
                        <div class="temp-val text-red" id="brakeTempVal">0°C</div>
                    </div>
                    <div class="temp-label">Brake</div>
                </div>
                <div class="temp-item">
                    <div class="temp-gauge-mini"><canvas id="tempTyreFL"></canvas>
                        <div class="temp-val text-green" id="tyreFLVal">0°C</div>
                    </div>
                    <div class="temp-label">Tyre FL</div>
                </div>
                <div class="temp-item">
                    <div class="temp-gauge-mini"><canvas id="tempTyreFR"></canvas>
                        <div class="temp-val text-green" id="tyreFRVal">0°C</div>
                    </div>
                    <div class="temp-label">Tyre FR</div>
                </div>
                <div class="temp-item">
                    <div class="temp-gauge-mini"><canvas id="tempTyreRL"></canvas>
                        <div class="temp-val text-green" id="tyreRLVal">0°C</div>
                    </div>
                    <div class="temp-label">Tyre RL</div>
                </div>
                <div class="temp-item">
                    <div class="temp-gauge-mini"><canvas id="tempTyreRR"></canvas>
                        <div class="temp-val text-green" id="tyreRRVal">0°C</div>
                    </div>
                    <div class="temp-label">Tyre RR</div>
                </div>
            </div>
        </div>

        <!-- COL 5: Trace Charts -->
        <div class="card traces-card">
            <div class="traces-stack">
                <div class="trace-box">
                    <div class="trace-label text-cyan">● SPEED</div>
                    <div class="trace-chart-wrapper"><canvas id="speedTraceChart"></canvas></div>
                </div>
                <div class="trace-box">
                    <div class="trace-label text-green">● THROTTLE</div>
                    <div class="trace-chart-wrapper"><canvas id="throttleTraceChart"></canvas></div>
                </div>
                <div class="trace-box">
                    <div class="trace-label text-red">● BRAKE</div>
                    <div class="trace-chart-wrapper"><canvas id="brakeTraceChart"></canvas></div>
                </div>
                <div class="trace-box">
                    <div class="trace-label text-yellow">● G-FORCE</div>
                    <div class="trace-chart-wrapper"><canvas id="gforceChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ROW 2: Analysis -->
        <div class="card analysis-card">
            <div class="card-title">Telemetry Analysis</div>
            <div class="analysis-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-cyan);"></div> Speed
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-green);"></div> Throttle
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-red);"></div> Brake
                </div>
            </div>
            <div class="analysis-chart-wrapper">
                <canvas id="analysisChart"></canvas>
            </div>
        </div>

    </main>

    <script>
        // =====================================================================
        // CONFIGURATION & STATE
        // =====================================================================
        const ws = new WebSocket('ws://' + window.location.host);
        const MAX_DATA_POINTS = 300; // ~5 seconds at 60Hz

        // Data arrays for charts
        const timeLabels = [];
        const speedData = [];
        const throttleData = [];
        const brakeData = [];
        const rpmData = [];

        // Session stats
        let maxSpeed = 0;
        let maxRpm = 0;
        let speedSum = 0;
        let rpmSum = 0;
        let dataCount = 0;
        let sessionId = 'SESSION_' + Date.now();

        // Load driver info from localStorage (set by driver-setup.html)
        const driverName = localStorage.getItem('f1_driver_name') || 'Unknown Driver';
        const teamName = localStorage.getItem('f1_team_name') || 'Unknown Team';
        const sessionName = localStorage.getItem('f1_session_name') || 'Free Practice';

        // Split name for styling (first name normal, last name highlighted)
        function formatDriverName(name) {
            const parts = name.trim().split(' ');
            if (parts.length > 1) {
                const lastName = parts.pop();
                return `${parts.join(' ')} <span>${lastName.toUpperCase()}</span>`;
            }
            return `<span>${name.toUpperCase()}</span>`;
        }

        document.getElementById('driverDisplay').innerHTML = formatDriverName(driverName);
        document.getElementById('teamDisplay').textContent = teamName;
        document.getElementById('sessionDisplay').textContent = sessionName;

        // =====================================================================
        // CHART DEFAULTS
        // =====================================================================
        Chart.defaults.color = '#555';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = "'Akrobat', sans-serif";

        // =====================================================================
        // GAUGE CHART FACTORY
        // =====================================================================
        function createGaugeChart(canvasId, color, maxValue) {
            return new Chart(document.getElementById(canvasId), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, maxValue],
                        backgroundColor: [color, 'rgba(255,255,255,0.03)'],
                        borderWidth: 0,
                        circumference: 270,
                        rotation: -135,
                        cutout: '82%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { tooltip: { enabled: false }, legend: { display: false } }
                }
            });
        }

        function createTempGauge(canvasId, color) {
            return new Chart(document.getElementById(canvasId), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [color, 'rgba(255,255,255,0.03)'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: -90,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { tooltip: { enabled: false }, legend: { display: false } }
                }
            });
        }

        // =====================================================================
        // TRACE CHART FACTORY
        // =====================================================================
        function createTraceChart(canvasId, color, maxY, fill = false) {
            return new Chart(document.getElementById(canvasId), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        data: canvasId === 'speedTraceChart' ? speedData :
                            canvasId === 'throttleTraceChart' ? throttleData : brakeData,
                        borderColor: color,
                        backgroundColor: fill ? color.replace(')', ', 0.2)').replace('rgb', 'rgba') : 'transparent',
                        fill: fill,
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: 0, max: maxY }
                    }
                }
            });
        }

        // =====================================================================
        // INITIALIZE CHARTS
        // =====================================================================

        // Main Gauges - Using RadialGauge
        const speedGauge = new RadialGauge({
            renderTo: 'speedGaugeChart',
            width: 300,
            height: 300,
            units: "KM/H",
            title: "",
            minValue: 0,
            maxValue: 360,
            majorTicks: [0, 40, 80, 120, 160, 200, 240, 280, 320, 360],
            minorTicks: 4,
            strokeTicks: true,
            highlights: [
                { from: 0, to: 120, color: "rgba(164, 210, 51, 0.2)" },
                { from: 120, to: 240, color: "rgba(164, 210, 51, 0.3)" },
                { from: 240, to: 360, color: "rgba(164, 210, 51, 0.5)" }
            ],
            ticksAngle: 270,
            startAngle: 45,
            colorMajorTicks: "#666",
            colorMinorTicks: "#444",
            colorTitle: "#a4d233",
            colorUnits: "#888",
            colorNumbers: "#a4d233",
            colorPlate: "transparent",
            borderShadowWidth: 0,
            borders: false,
            needleType: "arrow",
            needleWidth: 3,
            needleCircleSize: 8,
            needleCircleOuter: true,
            needleCircleInner: false,
            animationDuration: 100,
            animationRule: "linear",
            colorNeedle: "#a4d233",
            colorNeedleEnd: "#a4d233",
            colorNeedleShadowDown: "#000",
            colorNeedleCircleOuter: "#a4d233",
            colorNeedleCircleOuterEnd: "#a4d233",
            colorNeedleCircleInner: "#222",
            colorNeedleCircleInnerEnd: "#222",
            valueBox: false,
            value: 0
        }).draw();

        const rpmGauge = new RadialGauge({
            renderTo: 'rpmGaugeChart',
            width: 300,
            height: 300,
            units: "RPM",
            title: "",
            minValue: 0,
            maxValue: 15000,
            majorTicks: [0, 2000, 4000, 6000, 8000, 10000, 12000, 14000, 15000],
            minorTicks: 4,
            strokeTicks: true,
            highlights: [
                { from: 0, to: 10000, color: "rgba(255, 59, 59, 0.2)" },
                { from: 10000, to: 13000, color: "rgba(255, 59, 59, 0.3)" },
                { from: 13000, to: 15000, color: "rgba(255, 59, 59, 0.6)" }
            ],
            ticksAngle: 270,
            startAngle: 45,
            colorMajorTicks: "#666",
            colorMinorTicks: "#444",
            colorTitle: "#ff3b3b",
            colorUnits: "#888",
            colorNumbers: "#ff3b3b",
            colorPlate: "transparent",
            borderShadowWidth: 0,
            borders: false,
            needleType: "arrow",
            needleWidth: 3,
            needleCircleSize: 8,
            needleCircleOuter: true,
            needleCircleInner: false,
            animationDuration: 100,
            animationRule: "linear",
            colorNeedle: "#ff3b3b",
            colorNeedleEnd: "#ff3b3b",
            colorNeedleShadowDown: "#000",
            colorNeedleCircleOuter: "#ff3b3b",
            colorNeedleCircleOuterEnd: "#ff3b3b",
            colorNeedleCircleInner: "#222",
            colorNeedleCircleInnerEnd: "#222",
            valueBox: false,
            value: 0
        }).draw();

        // Temperature Gauges
        const tempCharts = {
            engine: createTempGauge('tempEngine', '#ff3b3b'),
            brake: createTempGauge('tempBrake', '#ff6b00'),
            tyreFL: createTempGauge('tempTyreFL', '#00ff66'),
            tyreFR: createTempGauge('tempTyreFR', '#00ff66'),
            tyreRL: createTempGauge('tempTyreRL', '#00ff66'),
            tyreRR: createTempGauge('tempTyreRR', '#00ff66')
        };

        // Trace Charts
        const speedTrace = createTraceChart('speedTraceChart', '#a4d233', 360);
        const throttleTrace = createTraceChart('throttleTraceChart', '#00ff66', 100, true);
        const brakeTrace = createTraceChart('brakeTraceChart', '#ff3b3b', 100, true);

        // G-Force Scatter
        const gforceChart = new Chart(document.getElementById('gforceChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    data: [],
                    backgroundColor: '#ffcc00',
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { min: -4, max: 4, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { display: false } },
                    y: { min: -4, max: 4, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { display: false } }
                }
            }
        });

        // Analysis Multi-Line Chart
        const analysisChart = new Chart(document.getElementById('analysisChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    { label: 'Speed', data: speedData, borderColor: '#a4d233', borderWidth: 2, yAxisID: 'ySpeed', pointRadius: 0, tension: 0.3 },
                    { label: 'Throttle', data: throttleData, borderColor: '#00ff66', borderWidth: 1.5, yAxisID: 'yPercent', pointRadius: 0, tension: 0.1 },
                    { label: 'Brake', data: brakeData, borderColor: '#ff3b3b', borderWidth: 1.5, yAxisID: 'yPercent', pointRadius: 0, tension: 0.1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { display: false } },
                    ySpeed: { type: 'linear', position: 'left', min: 0, max: 360, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a4d233', font: { size: 10 } } },
                    yPercent: { type: 'linear', position: 'right', min: 0, max: 100, grid: { display: false }, ticks: { color: '#888', font: { size: 10 } } }
                }
            }
        });

        // =====================================================================
        // HELPER FUNCTIONS
        // =====================================================================

        function updateGauge(gauge, value) {
            gauge.value = value;
        }

        function updateTempGauge(chart, value, max, elId) {
            const clamped = Math.min(value, max);
            chart.data.datasets[0].data[0] = clamped;
            chart.data.datasets[0].data[1] = max - clamped;
            chart.update('none');
            document.getElementById(elId).textContent = Math.round(value) + '°C';
        }

        function formatLapTime(ms) {
            if (!ms || ms <= 0) return '0:00.000';
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            const millis = ms % 1000;
            return `${mins}:${secs.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
        }

        function getDriverStatus(status) {
            const statuses = ['In Garage', 'Flying Lap', 'In Lap', 'Out Lap', 'On Track'];
            return statuses[status] || 'Unknown';
        }

        // =====================================================================
        // WEBSOCKET HANDLERS
        // =====================================================================

        ws.onopen = () => {
            console.log('WebSocket connected');
            // Send driver info to server
            ws.send(JSON.stringify({
                type: 'setDriver',
                driverName: driverName,
                sessionName: sessionName,
                sessionId: sessionId
            }));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            dataCount++;

            // === UPDATE SPEED ===
            const speed = Math.round(data.speed || 0);
            document.getElementById('speedValue').textContent = speed;
            updateGauge(speedGauge, speed);

            // Track max/avg speed
            if (speed > maxSpeed) maxSpeed = speed;
            speedSum += speed;
            document.getElementById('maxSpeed').textContent = maxSpeed;
            document.getElementById('maxSpeedGauge').textContent = maxSpeed;
            document.getElementById('avgSpeed').textContent = Math.round(speedSum / dataCount);

            // === UPDATE RPM & GEAR ===
            const rpm = Math.round(data.rpm || 0);
            const gear = data.gear;
            let gearText = gear === 0 ? 'N' : gear === -1 ? 'R' : gear;
            document.getElementById('gearValue').textContent = gearText;
            document.getElementById('rpmValue').textContent = rpm + ' RPM';
            updateGauge(rpmGauge, rpm);

            // Track max/avg RPM
            if (rpm > maxRpm) maxRpm = rpm;
            rpmSum += rpm;
            document.getElementById('maxRpm').textContent = maxRpm;
            document.getElementById('avgRpm').textContent = Math.round(rpmSum / dataCount);

            // === UPDATE LAP TIME ===
            if (data.currentLapTimeStr) {
                document.getElementById('currentLap').textContent = data.currentLapTimeStr;
            }

            // === UPDATE LAP NUMBER ===
            if (data.currentLapNum !== undefined) {
                document.getElementById('lapNumber').textContent = data.currentLapNum;
            }

            // === UPDATE DRIVER STATUS ===
            if (data.driverStatus !== undefined) {
                document.getElementById('carStatus').textContent = getDriverStatus(data.driverStatus);
            }

            // === UPDATE TEMPERATURES ===
            // Engine temp (from CarTelemetryData.m_engineTemperature)
            updateTempGauge(tempCharts.engine, data.engineTemp || 0, 150, 'engineTempVal');

            // Brake temps (from CarTelemetryData.m_brakesTemperature[4])
            // Average of all 4 brakes
            const brakeAvg = Math.round(((data.brakeFL || 0) + (data.brakeFR || 0) + (data.brakeRL || 0) + (data.brakeRR || 0)) / 4);
            updateTempGauge(tempCharts.brake, brakeAvg, 1200, 'brakeTempVal');

            // Tyre surface temps (from CarTelemetryData.m_tyresSurfaceTemperature[4])
            // Order: RL, RR, FL, FR (as per F1 UDP spec)
            updateTempGauge(tempCharts.tyreFL, data.tyreFL || 0, 120, 'tyreFLVal');
            updateTempGauge(tempCharts.tyreFR, data.tyreFR || 0, 120, 'tyreFRVal');
            updateTempGauge(tempCharts.tyreRL, data.tyreRL || 0, 120, 'tyreRLVal');
            updateTempGauge(tempCharts.tyreRR, data.tyreRR || 0, 120, 'tyreRRVal');

            // === UPDATE TRACE DATA ===
            if (timeLabels.length >= MAX_DATA_POINTS) {
                timeLabels.shift();
                speedData.shift();
                throttleData.shift();
                brakeData.shift();
                rpmData.shift();
                if (gforceChart.data.datasets[0].data.length > 0) {
                    gforceChart.data.datasets[0].data.shift();
                }
            }

            timeLabels.push('');
            speedData.push(speed);
            throttleData.push(data.throttle || 0);
            brakeData.push(data.brake || 0);
            rpmData.push(rpm);

            // G-Force (from CarMotionData.m_gForceLateral/Longitudinal)
            gforceChart.data.datasets[0].data.push({
                x: data.gForceLateral || 0,
                y: data.gForceLongitudinal || 0
            });

            // === REFRESH ALL TRACE CHARTS ===
            speedTrace.update('none');
            throttleTrace.update('none');
            brakeTrace.update('none');
            gforceChart.update('none');
            analysisChart.update('none');
        };

        ws.onerror = (err) => console.error('WebSocket error:', err);

        ws.onclose = () => {
            console.log('WebSocket closed. Reconnecting in 3s...');
            setTimeout(() => window.location.reload(), 3000);
        };
    </script>
</body>

</html>